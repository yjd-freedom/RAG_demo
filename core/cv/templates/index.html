<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>YOLO + RAG å®æ—¶ç‰©ä½“è¯†åˆ«ç³»ç»Ÿ</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: "Microsoft YaHei", "PingFang SC", sans-serif;
      background: #f5f7fa;
      color: #333;
      padding: 20px;
    }
    .header {
      text-align: center;
      margin-bottom: 20px;
    }
    .header h1 {
      color: #1890ff;
      font-size: 24px;
    }

    .main-layout {
      display: flex;
      gap: 20px;
      max-width: 1200px;
      margin: 0 auto;
      flex-wrap: wrap;
    }

    .video-section {
      flex: 1;
      min-width: 500px;
      background: #000;
      border-radius: 8px;
      overflow: hidden;
      position: relative;
    }

    .video-section img {
      width: 100%;
      display: block;
      object-fit: contain; /* é˜²æ­¢æ‹‰ä¼¸å˜å½¢ */
    }

    .info-section {
      flex: 0 0 300px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .card {
      background: white;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .card h2 {
      font-size: 16px;
      margin-bottom: 12px;
      color: #555;
      border-bottom: 1px solid #eee;
      padding-bottom: 6px;
    }

    .similarity {
      color: #fa8c16;
      font-weight: bold;
      margin-right: 8px;
    }

    #cropImage {
      width: 100%;
      height: auto;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-top: 8px;
    }

    #descriptionText {
      min-height: 80px;
      line-height: 1.6;
      color: #333;
      /* âœ… å…³é”®ä¿®å¤ï¼šç¡®ä¿é•¿æ–‡æœ¬è‡ªåŠ¨æ¢è¡Œä¸”ä¸è¢«æˆªæ–­ */
      word-break: break-word;
      white-space: pre-wrap; /* ä¿ç•™ç©ºæ ¼å’Œæ¢è¡Œ */
      overflow-wrap: break-word;
      hyphens: auto;
      padding: 10px;
      background: #f9f9f9;
      border: 1px solid #eee;
      border-radius: 4px;
      max-height: 300px;
      overflow-y: auto;
    }

    .empty {
      color: #999;
      font-style: italic;
      text-align: center;
      padding: 20px 0;
    }

    @media (max-width: 768px) {
      .main-layout {
        flex-direction: column;
      }
      .video-section {
        min-width: auto;
      }
      .info-section {
        flex: none;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>ğŸ¤– YOLO + RAG å®æ—¶ç‰©ä½“è¯†åˆ«ç³»ç»Ÿ</h1>
  </div>

  <div class="main-layout">
    <!-- å·¦ä¾§ï¼šè§†é¢‘æµ -->
    <div class="video-section">
      <img id="videoStream" src="/video_feed" alt="å®æ—¶è§†é¢‘æµ" />
    </div>

    <!-- å³ä¾§ï¼šä¿¡æ¯é¢æ¿ -->
    <div class="info-section">
      <!-- ä¸Šï¼šYOLO æ£€æµ‹ç»“æœï¼ˆå¸¦è£å‰ªå›¾ï¼‰ -->
      <div class="card">
        <h2>YOLO åœ¨æ‘„åƒå¤´ä¸­æ•æ‰çš„å¸¦æ ‡æ³¨ç‰©ä½“</h2>
        <div id="detectionsList">
          <div class="empty">æš‚æ— æ£€æµ‹ç»“æœ</div>
        </div>
      </div>

      <!-- ä¸‹ï¼šOllama ç”Ÿæˆçš„è‡ªç„¶è¯­è¨€æè¿° -->
      <div class="card">
        <h2>æ£€ç´¢å‡ºæ¥çš„å¯¹ç‰©ä½“çš„æè¿°</h2>
        <div id="descriptionText" class="empty">ç­‰å¾…æ£€æµ‹åˆ°ç‰©ä½“...</div>
      </div>
    </div>
  </div>

  <script>
    const videoStream = document.getElementById('videoStream');
    const detectionsList = document.getElementById('detectionsList');
    const descriptionText = document.getElementById('descriptionText');

    // ç¼“å­˜æœ‰æ•ˆæ•°æ®
    let lastValidDetections = null;
    let lastValidDescription = null;

    async function updateData() {
      try {
        const res = await fetch('/api/detections');
        if (!res.ok) throw new Error('API è¯·æ±‚å¤±è´¥');
        const data = await res.json();

        const hasValidData = Array.isArray(data) && data.length > 0;

        if (hasValidData) {
          lastValidDetections = data.slice(0, 3);
          // âœ… ä¼˜å…ˆä½¿ç”¨ LLM ç”Ÿæˆçš„è‡ªç„¶è¯­è¨€å›å¤ï¼ˆllm_replyï¼‰ï¼Œè¿™æ˜¯ç»™ç”¨æˆ·çœ‹çš„ï¼
          const reply = data[0].llm_reply || data[0].description || "å‘ç°ä¸€ä¸ªæœªçŸ¥ç‰©ä½“";
          lastValidDescription = reply;

          // æ¸²æŸ“æ£€æµ‹ç»“æœï¼ˆå«è£å‰ªå›¾ï¼‰
          renderDetectionWithCrop(data);

          // âœ… å…³é”®ä¿®å¤ï¼šä½¿ç”¨ innerText è€Œé textContentï¼Œä¿ç•™æ¢è¡Œï¼›åŒæ—¶ç¡®ä¿æ ·å¼æ”¯æŒå®Œæ•´æ˜¾ç¤º
          descriptionText.innerText = lastValidDescription;
          descriptionText.className = ''; // ç§»é™¤ empty æ ·å¼
        } else {
          if (!lastValidDetections) {
            detectionsList.innerHTML = '<div class="empty">æš‚æ— æ£€æµ‹ç»“æœ</div>';
            descriptionText.innerText = 'ç­‰å¾…æ£€æµ‹åˆ°ç‰©ä½“...';
            descriptionText.className = 'empty';
          }
        }
      } catch (err) {
        console.error('è·å–æ•°æ®å¤±è´¥:', err);
        if (!lastValidDetections) {
          detectionsList.innerHTML = '<div class="empty">âŒ åŠ è½½å¤±è´¥</div>';
          descriptionText.innerText = 'æœåŠ¡å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥åç«¯';
          descriptionText.className = 'empty';
        }
      }
    }

    /**
     * æ¸²æŸ“æ£€æµ‹ç»“æœå¹¶å°è¯•è£å‰ªå›¾åƒ
     * æ³¨æ„ï¼šç”±äºæµè§ˆå™¨å®‰å…¨é™åˆ¶ï¼Œä» <img> è¯»å–åƒç´ å¯èƒ½å¤±è´¥ã€‚
     * å› æ­¤å¢åŠ å®¹é”™ï¼šè‹¥è£å‰ªå¤±è´¥ï¼Œåªæ˜¾ç¤ºæ–‡å­—ä¿¡æ¯ã€‚
     */
    function renderDetectionWithCrop(detections) {
      const firstItem = detections[0];
      const bbox = firstItem.bbox;
      const [x1, y1, x2, y2] = bbox;
      const label = firstItem.description ? firstItem.description.split('æ˜¯')[0] : 'æœªçŸ¥';

      // è·å–åŸå§‹å¸§å°ºå¯¸ï¼ˆç”±åç«¯ detector.py æä¾›ï¼‰
      const originalWidth = firstItem.original_width || 640;
      const originalHeight = firstItem.original_height || 480;

      // åˆ›å»ºä¸» canvasï¼ˆåŸå§‹å°ºå¯¸ï¼‰
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = originalWidth;
      canvas.height = originalHeight;

      // å°è¯•ç»˜åˆ¶è§†é¢‘å¸§åˆ° canvas
      try {
        // âœ… å…³é”®ä¿®å¤ï¼šåªæœ‰å½“ videoStream å®Œå…¨åŠ è½½åæ‰ç»˜åˆ¶
        if (videoStream.complete && videoStream.naturalWidth > 0) {
          ctx.drawImage(videoStream, 0, 0, canvas.width, canvas.height);

          // è£å‰ªåŒºåŸŸ
          const cropCanvas = document.createElement('canvas');
          cropCanvas.width = Math.max(1, x2 - x1);
          cropCanvas.height = Math.max(1, y2 - y1);
          const cropCtx = cropCanvas.getContext('2d');
          cropCtx.drawImage(canvas, x1, y1, cropCanvas.width, cropCanvas.height);

          const cropImg = document.createElement('img');
          cropImg.src = cropCanvas.toDataURL('image/png');
          cropImg.style.maxWidth = '100%';
          cropImg.style.border = '1px solid #ddd';
          cropImg.style.borderRadius = '4px';

          const content = `
            <div style="font-size: 14px; margin-bottom: 8px;">
              <span class="similarity">ç›¸ä¼¼åº¦: ${firstItem.similarity.toFixed(3)}</span>
              ${label}
            </div>
          `;
          detectionsList.innerHTML = content;
          detectionsList.appendChild(cropImg);
        } else {
          // å›¾åƒæœªåŠ è½½å®Œæˆï¼Œåªæ˜¾ç¤ºæ–‡å­—
          const content = `
            <div style="font-size: 14px; margin-bottom: 8px;">
              <span class="similarity">ç›¸ä¼¼åº¦: ${firstItem.similarity.toFixed(3)}</span>
              ${label}
            </div>
            <div class="empty">å›¾åƒåŠ è½½ä¸­...</div>
          `;
          detectionsList.innerHTML = content;
          // ç¨åé‡è¯•ï¼ˆå¯é€‰ï¼‰
        }
      } catch (e) {
        console.warn('è£å‰ªå›¾åƒå¤±è´¥ï¼ˆå¯èƒ½å›  CORS æˆ–å›¾åƒæœªåŠ è½½ï¼‰:', e);
        // å³ä½¿å¤±è´¥ï¼Œä¹Ÿè‡³å°‘æ˜¾ç¤ºæ–‡å­—ä¿¡æ¯
        const content = `
          <div style="font-size: 14px; margin-bottom: 8px;">
            <span class="similarity">ç›¸ä¼¼åº¦: ${firstItem.similarity.toFixed(3)}</span>
            ${label}
          </div>
          <div class="empty">æ— æ³•æ˜¾ç¤ºè£å‰ªå›¾</div>
        `;
        detectionsList.innerHTML = content;
      }
    }

    // åˆå§‹åŠ è½½ + æ¯ 200ms æ›´æ–°
    updateData();
    setInterval(updateData, 200);

    // è§†é¢‘æµé”™è¯¯å¤„ç†
    videoStream.onerror = () => {
      alert('âš ï¸ æ— æ³•åŠ è½½è§†é¢‘æµï¼Œè¯·ç¡®ä¿æ‘„åƒå¤´å·²å¯ç”¨ä¸”åç«¯è¿è¡Œæ­£å¸¸ã€‚');
    };
  </script>
</body>
</html>