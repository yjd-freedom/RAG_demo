<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>YOLO + RAG å®æ—¶ç‰©ä½“è¯†åˆ«ç³»ç»Ÿ</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: "Microsoft YaHei", "PingFang SC", sans-serif;
      background: #f5f7fa;
      color: #333;
      padding: 20px;
    }
    .header {
      text-align: center;
      margin-bottom: 20px;
    }
    .header h1 {
      color: #1890ff;
      font-size: 24px;
    }

    .main-layout {
      display: flex;
      gap: 20px;
      max-width: 1200px;
      margin: 0 auto;
      flex-wrap: wrap;
    }

    .video-section {
      flex: 1;
      min-width: 500px;
      background: #000;
      border-radius: 8px;
      overflow: hidden;
      position: relative;
    }

    .video-section img {
      width: 100%;
      display: block;
    }

    .info-section {
      flex: 0 0 300px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .card {
      background: white;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .card h2 {
      font-size: 16px;
      margin-bottom: 12px;
      color: #555;
      border-bottom: 1px solid #eee;
      padding-bottom: 6px;
    }

    .similarity {
      color: #fa8c16;
      font-weight: bold;
      margin-right: 8px;
    }

    #cropImage {
      width: 100%;
      height: auto;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-top: 8px;
    }

    #descriptionText {
      min-height: 80px;
      line-height: 1.5;
      color: #333;
      word-break: break-word;
      white-space: pre-wrap; /* âœ… æ”¯æŒæ¢è¡Œ */
      overflow-y: auto;     /* âœ… å¯æ»šåŠ¨ */
      max-height: 300px;
      padding: 8px;
      background: #f9f9f9;
      border: 1px solid #eee;
      border-radius: 4px;
    }

    .empty {
      color: #998;
      font-style: italic;
      text-align: center;
      padding: 20px 0;
    }

    @media (max-width: 768px) {
      .main-layout {
        flex-direction: column;
      }
      .video-section {
        min-width: auto;
      }
      .info-section {
        flex: none;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>ğŸ¤– YOLO + RAG å®æ—¶ç‰©ä½“è¯†åˆ«ç³»ç»Ÿ</h1>
  </div>

  <div class="main-layout">
    <!-- å·¦ä¾§ï¼šè§†é¢‘æµ -->
    <div class="video-section">
      <img id="videoStream" src="/video_feed" alt="å®æ—¶è§†é¢‘æµ" />
    </div>

    <!-- å³ä¾§ï¼šä¿¡æ¯é¢æ¿ -->
    <div class="info-section">
      <!-- ä¸Šï¼šYOLO æ£€æµ‹ç»“æœï¼ˆå¸¦è£å‰ªå›¾ï¼‰ -->
      <div class="card">
        <h2>YOLO åœ¨æ‘„åƒå¤´ä¸­æ•æ‰çš„å¸¦æ ‡æ³¨ç‰©ä½“</h2>
        <div id="detectionsList">
          <div class="empty">æš‚æ— æ£€æµ‹ç»“æœ</div>
        </div>
      </div>

      <!-- ä¸‹ï¼šRAG æè¿° -->
      <div class="card">
        <h2>æ£€ç´¢å‡ºæ¥çš„å¯¹ç‰©ä½“çš„æè¿°</h2>
        <div id="descriptionText" class="empty">ç­‰å¾…æ£€æµ‹åˆ°ç‰©ä½“...</div>
      </div>
    </div>
  </div>

  <script>
    const videoStream = document.getElementById('videoStream');
    const detectionsList = document.getElementById('detectionsList');
    const descriptionText = document.getElementById('descriptionText');

    // ç¼“å­˜æœ‰æ•ˆæ•°æ®
    let lastValidDetections = null;
    let lastValidDescription = null;

    async function updateData() {
      try {
        const res = await fetch('/api/detections');
        if (!res.ok) throw new Error('API è¯·æ±‚å¤±è´¥');
        const data = await res.json();

        const hasValidData = Array.isArray(data) && data.length > 0;

        if (hasValidData) {
          // æ›´æ–°ç¼“å­˜
          lastValidDetections = data.slice(0, 3);
          lastValidDescription = data[0].description;

          // æ¸²æŸ“æ£€æµ‹åˆ—è¡¨ï¼ˆå¸¦è£å‰ªå›¾ï¼‰
          renderDetectionWithCrop(data);

          // æ¸²æŸ“å®Œæ•´æè¿°
          descriptionText.textContent = lastValidDescription;
          descriptionText.className = '';
        } else {
          // æ— æ–°æ•°æ®ï¼Œä¿ç•™ä¸Šæ¬¡å†…å®¹
          if (!lastValidDetections) {
            detectionsList.innerHTML = '<div class="empty">æš‚æ— æ£€æµ‹ç»“æœ</div>';
            descriptionText.textContent = 'ç­‰å¾…æ£€æµ‹åˆ°ç‰©ä½“...';
            descriptionText.className = 'empty';
          }
        }
      } catch (err) {
        console.error('è·å–æ•°æ®å¤±è´¥:', err);
        if (!lastValidDetections) {
          detectionsList.innerHTML = '<div class="empty">âŒ åŠ è½½å¤±è´¥</div>';
          descriptionText.textContent = 'æœåŠ¡å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥åç«¯';
          descriptionText.className = 'empty';
        }
      }
    }

    function renderDetectionWithCrop(detections) {
      const firstItem = detections[0];
      const bbox = firstItem.bbox;
      const [x1, y1, x2, y2] = bbox;
      const label = firstItem.description.split('æ˜¯')[0]; // æå–è§’è‰²å

      // è·å–åŸå§‹å›¾åƒå°ºå¯¸ï¼ˆæœªç¼©æ”¾ï¼‰
      const naturalWidth = videoStream.naturalWidth || videoStream.clientWidth;
      const naturalHeight = videoStream.naturalHeight || videoStream.clientHeight;

      // åˆ›å»º canvas å¹¶ç»˜åˆ¶åŸå›¾
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');

      // è®¾ç½® canvas å¤§å°ä¸ºåŸå§‹å›¾åƒå°ºå¯¸
      canvas.width = naturalWidth;
      canvas.height = naturalHeight;

      // ç»˜åˆ¶åŸå›¾åˆ° canvas
      ctx.drawImage(videoStream, 0, 0, canvas.width, canvas.height);

      // è£å‰ªç›®æ ‡åŒºåŸŸï¼ˆä½¿ç”¨åŸå§‹åæ ‡ï¼‰
      const cropCanvas = document.createElement('canvas');
      cropCanvas.width = x2 - x1;
      cropCanvas.height = y2 - y1;
      const cropCtx = cropCanvas.getContext('2d');
      cropCtx.drawImage(canvas, x1, y1, cropCanvas.width, cropCanvas.height);

      // åˆ›å»º image å…ƒç´ æ˜¾ç¤ºè£å‰ªå›¾
      const cropImg = document.createElement('img');
      cropImg.src = cropCanvas.toDataURL();
      cropImg.style.maxWidth = '100%';

      // æ„å»º HTML å†…å®¹
      const content = `
        <div style="font-size: 14px; margin-bottom: 8px;">
          <span class="similarity">ç›¸ä¼¼åº¦: ${firstItem.similarity.toFixed(3)}</span>
          ${label}
        </div>
        ${cropImg.outerHTML}
      `;

      detectionsList.innerHTML = content;
    }

    // åˆå§‹åŠ è½½ + æ¯ 200ms æ›´æ–°ï¼ˆæå‡å“åº”é€Ÿåº¦ï¼‰
    updateData();
    setInterval(updateData, 200); // â¬…ï¸ ä» 1000 æ”¹ä¸º 200ms

    // è§†é¢‘æµé”™è¯¯å¤„ç†
    videoStream.onerror = () => {
      alert('âš ï¸ æ— æ³•åŠ è½½è§†é¢‘æµï¼Œè¯·ç¡®ä¿æ‘„åƒå¤´å·²å¯ç”¨ä¸”åç«¯è¿è¡Œæ­£å¸¸ã€‚');
    };
  </script>
</body>
</html>